import json
import storage
import array
import math
import gc

from mag_cal.calibration import Calibration

calib = Calibration() #create calibration object

#----------------------------------------------------------------------------------------
#Run calibration

# Define the arrays (your data)
mag_array = [(10.125, -15.325, 17.325), (-25.7, -9.8625, 12.6875), (-20.2875, 29.775, -10.425), (-8.975, 35.5375, -18.25), (27.65, 8.0875, -30.3), (-10.125, -17.925, -28.0125), (-6.1875, -27.75, 3.95), (18.5625, -23.975, 5.3625), (33.5625, 7.55, -6.875), (18.7, 11.6875, -33.275), (-21.45, -1.1875, -27.3625), (-27.675, -4.5875, 6.1875), (-25.0625, 4.5875, -23.8875), (9.675, 26.6375, -30.625), (30.7875, 18.8, -0.4), (27.0125, -14.75, 3.8875), (-10.2875, -34.45, -5.15), (-34.6, 5.4625, -15.0), (-14.3375, 35.05, -7.075), (8.4875, 39.175, -10.0125), (19.0875, -12.4375, -36.525), (-15.7, -28.325, -5.4875), (25.025, -7.875, 14.5625), (32.0875, 1.1625, -3.5)]
grav_array = [(5.46999, -1.4668, 6.91047), (7.49432, 6.08734, -0.861416), (3.51625, 6.85065, -4.60857), (-5.11944, 1.38066, -7.90947), (4.86221, -4.75813, -6.44746), (1.90349, -9.17288, 3.2004), (-6.22492, -6.38764, 3.49113), (-9.68853, 2.6333, 0.9667), (-6.44626, 3.67298, -5.47956), (7.43689, -0.37328, -6.52403), (9.8321, -0.770488, 3.15135), (7.58764, 1.8987, -5.6327), (-3.28415, 8.03748, -5.67099), (-6.89372, 5.25942, 3.60718), (-8.78883, -4.44347, 2.57109), (3.27697, -8.89053, 3.32004), (9.67896, -1.02054, -0.0346959), (5.73081, 6.90209, -2.37607), (-0.149551, 8.46819, -3.00778), (-3.80818, -1.70249, -9.25663), (6.97866, -6.73699, 0.351745), (-6.4989, -1.11984, 6.80877), (-9.80937, 0.79322, 0.579063), (-6.22732, 0.34337, -8.00877)]

mag_accuracy, grav_accuracy =  calib.fit_ellipsoid(mag_array, grav_array)
#calib.fit_to_axis(aligned)
#calib.fit_non_linear_quick(aligned, param_count=5)

#----------------------------------------------------------------------------------------
#Test calibration

#create example sensor readings
mag = ([30.5, -12.8, 45.3])  # x, y, z components of the magnetic field
grav = ([0.0, 9.81, 0.0])  # x, y, z components of gravity

#run get angles code
azimuth, inclination, roll = calib.get_angles(mag, grav)
print(azimuth,inclination)

#----------------------------------------------------------------------------------------
#Save calibration

# Convert calibration object to a dictionary
calibration_dict = calib.as_dict()

# Save the calibration to a file on the device
with open("/calibration_data.json", "w") as file:
    json.dump(calibration_dict, file)

print("Calibration data saved.")